<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!--<link rel="stylesheet" href="mainStyle.css" />-->
    <style>
        body {
            margin: 0px;
        }
        
        html, body {
            height: 100%;
        }

        #gamesBox {
            width: 65%;
            height: 100%;
            float: right;
            background-color: blue;
        }

        #socialBox {
            width: 35%;
            height: 100%;
            float: left;
            background-color: pink;
        }

        #logAbs, #connectController {
            position: absolute;
            z-index: 10000;
            left: 50%;
            top: 35%;
        }        

        #logBox {
            position: relative;
            left: -50%;
            top: -35%;
            height: 10%;
            background: yellow;
        }

        .blockBox {
            position: absolute;
            z-index: 9000;
            background-color: black;
            opacity: 0.5;
            width: 100%;
            height: 100%;
        }

        #hostBox {
            width: 100%;
            height: 40%;
            float: left;
            background-color: red;
        }

        #chat {
            width: 100%;
            height: 57%;
            float: left;
        }

        #chat-text {
            width: 100%;
            height: 100%;
            overflow-y: scroll
        }

        #chat-input {
            width: 100%;
        }

        #chat-form {
            width: 100%;
            padding-top: 0%;
            margin-top: 1%;
            float: left;
        }

        .gameDiv {
            width: 400px;
            height: 100px;
            border: 1px solid black;
        }

        #controllerCode {
            position: absolute;
            background-color: pink;
            width: 100px;
            height: 100px;
            top: 170px;
            display: none;
         }

        #passBox{
            position: absolute;
            background-color: greenyellow;
            width: 100px;
            height: 100px;
            display: none;
        }

        #msgControls{
            position: absolute;
            bottom: 0px;
            left: 0px;
        }

        #messages {
            padding-left: 10px;
        }
        
        ul {
            list-style-type: none;
        }
    </style>
    <script>
        var partyStatusEnum = Object.freeze({ "public": 0, "private": 1, "full": 2 })

        var socket = io();

        var phoneModels = new RegExp('Android|webOS|iPhone|iPad|' +
            'BlackBerry|Windows Phone|' +
            'Opera Mini|IEMobile|Mobile',
            'i');

      /*  if (phoneModels.test(navigator.userAgent))
        {
            $('#logAbs').css('display', 'none');
            $('#connectController').css('display', 'block');

        }
        else {
            $('#logAbs').css('display', 'block');
            $('#connectController').css('display', 'none');

        }   */    

        function sendMsg()
        {
            socket.emit('message', $('#txtInp').val());
            $('#txtInp').val('');
        }

        socket.on('message', function (msg) {
            $('#messages').append($('<li>').text(msg));
            $("html, body").scrollTop($(document).height());
        });

        getLobbysFromServer();

        socket.on('addControlerResualt', function (data) {
            $('#controllerCode').css('display', 'none');
        });

        function getLobbysFromServer() {
            if (phoneModels.test(navigator.userAgent)) {
                window.open('/client/controllerPage.html');
            }
            socket.emit('getPartyList');
            socket.on('partyList', function (data) {
                let gamesBox = document.getElementById("gamesBox");
                if (gamesBox.firstChild) {
                    //usuwanie gameboxa
                    while (gamesBox.firstChild) {
                        gamesBox.removeChild(gamesBox.firstChild);
                    }
                }
                //wypełnianie game boxa
                for (var gameNum = 0; gameNum < data.length; gameNum++) {
                    let div = document.createElement("div");
                    let btn = document.createElement("button");
                    if (data[gameNum].id === socket.id) {
                        btn.innerText = 'Wyjdż z pokoju';
                        btn.id = 'btnForLinked'
                        btn.onclick = function () { leaveLobby(); };
                    }
                    else{
                        btn.innerText = 'Dołącz go gry';
                        btn.onclick = function () { joinLobby(this); };
                    }
                    btn.id = data[gameNum].id;
                    
                    div.classList.add('gameDiv');
                    div.id = data[gameNum].partyStatus + '?' + data[gameNum].id;
                    div.innerHTML = 'Gra użytkownika: ' + data[gameNum].firstPlayer.userName;
                    div.appendChild(btn);
                    document.getElementById("gamesBox").appendChild(div);
                }
            });
        }

        function addPlayer() {
            socket.emit('addPlayer', {
                userName: document.getElementById('userName').value
            });

            socket.on('addPlayerResult', function(data) {
                if (data === false)
                {                   
                    $('#logBox').css('display', 'none');
                    $('.blockBox').css('display', 'none');
                    getControllerCode();
                }
                else {
                    alert('Nazwa już istnieje. Wybierz inną.');
                }
            });
        }

        function addGuest() {
            socket.emit('addGuest');
            socket.on('addPlayerResult', function (data) {
                if (data === false) {
                    document.getElementsByClassName('blockBox')[0].style.display = "none";
                    document.getElementById('logBox').style.display = "none";
                }
            });
        }

        function hostGame()
        {            
            socket.emit('hostGame', {
                partyStatus: document.getElementById('partyStatus').selectedIndex,
                password: document.getElementById('password').value 
            });
            startGame();
        }; 

        function startGame()
        {
            socket.on('startGame', function (data) {
                localStorage.setItem('socketID', socket.id);
                localStorage.setItem('hostID', JSON.stringify(data));
                window.open('/client/gamePage.html');
            });
        }

        function joinLobby(e) {
            let statusStr = '';
            let idStr = '';            
            statusStr = e.parentElement.id.charAt(0);
            idStr = e.parentElement.id.substring(2);            
            if (statusStr == partyStatusEnum.private) {
                $('#passBox').css('display', 'block');
                $('#passBox').attr('value', idStr);
                startGame();
            }
            else {
                socket.emit('joinGame', { ID: idStr });
                startGame();
            }
        };   

        function leaveLobby() {
            socket.emit('adminLeaveLobby', {});

            socket.on('adminLeaveLobbyResault', function (data) {
                if (data == true)
                    getLobbysFromServer();
            });
        };   

        function getControllerCode() {
            socket.emit('getControllerCode', {});

            socket.on('getControllerCodeRes', function (code) {
                $('#aForCode').html(code);
                $('#controllerCode').css('display','block');
            });            
        }

        function checkPassword()
        {
            var isCorrect;
            socket.emit('checkPassword', {
                password: $('#pass-input').val(),
                id: $('#passBox').attr('value')
            });

            socket.on('checkPasswordResualt', function (data) {
                if(data.resualt)
                {
                    joinLobby(id);
                }
                else
                {
                    alert('Złe hasło');
                }
            });

       }

        
    </script>
</head>
<body onload="getLobbysFromServer()">
    <div class="blockBox"></div>
    <div id="logAbs">
        <div id="logBox">
            <a>Username</a><input type="text" id="userName" />
            <button onclick="addPlayer()">Zaloguj się</button>
            <button onclick="addGuest()">Wejdź jako gość</button>
        </div>
    </div>
    <div id="socialBox">
        <div id="hostBox">
            <select id="partyStatus" onchange="$('#password').toggle();">
                <option>Public</option>
                <option>Private</option>
            </select>
            <a>Hasło</a><input type="password" id="password" hidden/>
            <button onclick="hostGame()">Stwórz pokój</button>
        </div>          
        <div id="chat">
            <ul id="messages"></ul>
            <div id="msgControls">
                <input id="txtInp" autocomplete="off" /><button onclick="sendMsg()">Send</button>
            </div>
        </div>
    </div>
    <div id="gamesBox">

    </div>    
    <!--Divy z position absolute-->
    <div id="passBox">
        Wprowadź hasło: <input id="pass-input" type="password" />
        <button id="btnPass" onclick="checkPassword()">Enter</button>
    </div>
    <div id="controllerCode"> Wejdź wejdź na telefonie tutaj i wpisz poniższy kod.
        <a id="aForCode"></a>
    </div>
</body>
</html>

